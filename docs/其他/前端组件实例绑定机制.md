# å‰ç«¯ä¸‰ä¸ªåŸºç¡€ç»„ä»¶çš„å®ä¾‹ç»‘å®šæœºåˆ¶

*æ–‡æ¡£åˆ›å»ºï¼š2025å¹´9æœˆ30æ—¥*

## ğŸ¯ é—®é¢˜åˆ†æ

### å½“å‰çš„ä¸‰ä¸ªåŸºç¡€ç»„ä»¶
1. **ConnectionForm** - è¿æ¥é…ç½®è¡¨å•
2. **ModelSelect** - æ¨¡å‹é€‰æ‹©ä¸‹æ‹‰æ¡†  
3. **TokenUsage** - Tokenä½¿ç”¨ç»Ÿè®¡æ˜¾ç¤º

### å½“å‰çš„ç»‘å®šæœºåˆ¶
æ‰€æœ‰ä¸‰ä¸ªç»„ä»¶éƒ½ä½¿ç”¨ `useConnectionManager()` Hookï¼š

```tsx
// ConnectionForm.tsx
const ConnectionForm = () => {
  const { 
    providerId, apiKey, baseUrl, status,
    setProviderId, setApiKey, setBaseUrl,
    handleConnect, handleDisconnect
  } = useConnectionManager(); // ğŸ‘ˆ é€šè¿‡Contextè‡ªåŠ¨ç»‘å®š
  
  // UIé€»è¾‘...
};

// ModelSelect.tsx  
const ModelSelect = () => {
  const {
    model, modelOptions, 
    setModel, fetchModels
  } = useConnectionManager(); // ğŸ‘ˆ é€šè¿‡Contextè‡ªåŠ¨ç»‘å®š
  
  // UIé€»è¾‘...
};

// TokenUsage.tsx
const TokenUsage = () => {
  const { tokenUsage } = useConnectionManager(); // ğŸ‘ˆ é€šè¿‡Contextè‡ªåŠ¨ç»‘å®š
  
  // UIé€»è¾‘...
};
```

## âœ… å¥½æ¶ˆæ¯ï¼šè‡ªåŠ¨ç»‘å®šå·²ç»å·¥ä½œï¼

### React Context çš„å·¥ä½œåŸç†
ç”±äºä½¿ç”¨äº†React Contextæœºåˆ¶ï¼Œè¿™ä¸‰ä¸ªç»„ä»¶ä¼š**è‡ªåŠ¨ç»‘å®šåˆ°æœ€è¿‘çš„ä¸Šçº§ `LlmConnectorProvider`**ï¼š

```tsx
// å¤šå®ä¾‹åœºæ™¯ä¸‹çš„è‡ªåŠ¨ç»‘å®š
function App() {
  return (
    <div>
      {/* æ€»ç»“å®ä¾‹ */}
      <LlmConnectorProvider name="summary" storageKey="summary-config">
        <div className="summary-section">
          <h3>ğŸ“„ æ€»ç»“åŠ©æ‰‹</h3>
          <ConnectionForm />  {/* ğŸ‘ˆ è‡ªåŠ¨ç»‘å®šåˆ° summary å®ä¾‹ */}
          <ModelSelect />     {/* ğŸ‘ˆ è‡ªåŠ¨ç»‘å®šåˆ° summary å®ä¾‹ */}
          <TokenUsage />      {/* ğŸ‘ˆ è‡ªåŠ¨ç»‘å®šåˆ° summary å®ä¾‹ */}
          <SummaryInterface />
        </div>
      </LlmConnectorProvider>
      
      {/* å¯¹è¯å®ä¾‹ */}
      <LlmConnectorProvider name="chat" storageKey="chat-config">
        <div className="chat-section">
          <h3>ğŸ’¬ å¯¹è¯åŠ©æ‰‹</h3>
          <ConnectionForm />  {/* ğŸ‘ˆ è‡ªåŠ¨ç»‘å®šåˆ° chat å®ä¾‹ */}
          <ModelSelect />     {/* ğŸ‘ˆ è‡ªåŠ¨ç»‘å®šåˆ° chat å®ä¾‹ */}
          <TokenUsage />      {/* ğŸ‘ˆ è‡ªåŠ¨ç»‘å®šåˆ° chat å®ä¾‹ */}
          <ChatInterface />
        </div>
      </LlmConnectorProvider>
    </div>
  );
}
```

### Context æŸ¥æ‰¾æœºåˆ¶
```
<LlmConnectorProvider name="summary">     â† summary å®ä¾‹çš„Context
  <ConnectionForm />                      â† useConnectionManager() æ‰¾åˆ° summary Context
  <ModelSelect />                         â† useConnectionManager() æ‰¾åˆ° summary Context
  <TokenUsage />                          â† useConnectionManager() æ‰¾åˆ° summary Context
</LlmConnectorProvider>

<LlmConnectorProvider name="chat">        â† chat å®ä¾‹çš„Context  
  <ConnectionForm />                      â† useConnectionManager() æ‰¾åˆ° chat Context
  <ModelSelect />                         â† useConnectionManager() æ‰¾åˆ° chat Context
  <TokenUsage />                          â† useConnectionManager() æ‰¾åˆ° chat Context
</LlmConnectorProvider>
```

## ğŸ” éªŒè¯è‡ªåŠ¨ç»‘å®šçš„å·¥ä½œçŠ¶æ€

### æµ‹è¯•ç”¨ä¾‹1ï¼šåŸºæœ¬å¤šå®ä¾‹
```tsx
// éªŒè¯è‡ªåŠ¨ç»‘å®šæ˜¯å¦æ­£å¸¸å·¥ä½œ
function MultiInstanceTest() {
  return (
    <div style={{ display: 'flex', gap: '20px' }}>
      {/* å®ä¾‹A */}
      <LlmConnectorProvider name="instance-a" storageKey="test-a">
        <div style={{ border: '2px solid blue', padding: '16px' }}>
          <h3>å®ä¾‹A (è“è‰²è¾¹æ¡†)</h3>
          <ConnectionFormZh />
          <ModelSelectZh />
          <TokenUsageZh />
        </div>
      </LlmConnectorProvider>
      
      {/* å®ä¾‹B */}
      <LlmConnectorProvider name="instance-b" storageKey="test-b">
        <div style={{ border: '2px solid red', padding: '16px' }}>
          <h3>å®ä¾‹B (çº¢è‰²è¾¹æ¡†)</h3>
          <ConnectionFormZh />
          <ModelSelectZh />
          <TokenUsageZh />
        </div>
      </LlmConnectorProvider>
    </div>
  );
}
```

**é¢„æœŸç»“æœ**ï¼š
- è“è‰²è¾¹æ¡†å†…çš„ç»„ä»¶æ“ä½œåªå½±å“å®ä¾‹Açš„çŠ¶æ€
- çº¢è‰²è¾¹æ¡†å†…çš„ç»„ä»¶æ“ä½œåªå½±å“å®ä¾‹Bçš„çŠ¶æ€
- ä¸¤ä¸ªå®ä¾‹çš„é…ç½®å®Œå…¨ç‹¬ç«‹

### æµ‹è¯•ç”¨ä¾‹2ï¼šåµŒå¥—å®ä¾‹
```tsx
// éªŒè¯åµŒå¥—åœºæ™¯ä¸‹çš„ç»‘å®š
function NestedInstanceTest() {
  return (
    <LlmConnectorProvider name="outer" storageKey="outer-config">
      <div style={{ border: '2px solid green', padding: '16px' }}>
        <h3>å¤–å±‚å®ä¾‹</h3>
        <ConnectionFormZh />  {/* ç»‘å®šåˆ° outer å®ä¾‹ */}
        
        <LlmConnectorProvider name="inner" storageKey="inner-config">
          <div style={{ border: '2px solid orange', padding: '16px', margin: '16px 0' }}>
            <h3>å†…å±‚å®ä¾‹</h3>
            <ConnectionFormZh />  {/* ç»‘å®šåˆ° inner å®ä¾‹ */}
            <ModelSelectZh />     {/* ç»‘å®šåˆ° inner å®ä¾‹ */}
          </div>
        </LlmConnectorProvider>
        
        <ModelSelectZh />       {/* ç»‘å®šåˆ° outer å®ä¾‹ */}
      </div>
    </LlmConnectorProvider>
  );
}
```

## ğŸš¨ æ½œåœ¨é—®é¢˜å’Œæ”¹è¿›æ–¹æ¡ˆ

### é—®é¢˜1ï¼šç»‘å®šå…³ç³»ä¸å¤Ÿç›´è§‚
è™½ç„¶è‡ªåŠ¨ç»‘å®šå·¥ä½œæ­£å¸¸ï¼Œä½†å¼€å‘è€…ä¸å®¹æ˜“çœ‹å‡ºç»‘å®šå…³ç³»ã€‚

**è§£å†³æ–¹æ¡ˆï¼šè§†è§‰æ ‡è¯†**
```tsx
// æ”¹è¿›ç‰ˆæœ¬ï¼šæ·»åŠ å®ä¾‹æ ‡è¯†
const ConnectionFormWithIndicator = ({ className, locale }) => {
  const { instanceName } = useLlmConnector(); // è·å–å®ä¾‹åç§°
  const connectionData = useConnectionManager();
  
  return (
    <div className={className}>
      {/* å®ä¾‹æ ‡è¯†å™¨ */}
      <div className="instance-indicator">
        <span className="badge">ğŸ”— {instanceName || 'default'}</span>
        <span className="status">
          {connectionData.status === 'connected' ? 'âœ…' : 'âŒ'}
        </span>
      </div>
      
      {/* åŸæœ‰çš„è¿æ¥è¡¨å• */}
      <div className="connection-form">
        {/* è¡¨å•å†…å®¹ */}
      </div>
    </div>
  );
};
```

### é—®é¢˜2ï¼šè°ƒè¯•å›°éš¾
å½“æœ‰é—®é¢˜æ—¶ï¼Œå¾ˆéš¾å¿«é€Ÿè¯†åˆ«æ˜¯å“ªä¸ªå®ä¾‹çš„ç»„ä»¶å‡ºäº†é—®é¢˜ã€‚

**è§£å†³æ–¹æ¡ˆï¼šè°ƒè¯•å¢å¼º**
```tsx
// åœ¨ç»„ä»¶ä¸­æ·»åŠ è°ƒè¯•ä¿¡æ¯
const ModelSelectWithDebug = ({ className, locale }) => {
  const { instanceName } = useLlmConnector();
  const { model, modelOptions, status } = useConnectionManager();
  
  // è°ƒè¯•æ—¥å¿—
  useEffect(() => {
    console.log(`[${instanceName}] ModelSelect - å½“å‰æ¨¡å‹:`, model);
    console.log(`[${instanceName}] ModelSelect - å¯ç”¨æ¨¡å‹:`, modelOptions);
    console.log(`[${instanceName}] ModelSelect - è¿æ¥çŠ¶æ€:`, status);
  }, [instanceName, model, modelOptions, status]);
  
  return (
    <div className={className} data-instance={instanceName}>
      {/* ç»„ä»¶å†…å®¹ */}
    </div>
  );
};
```

### é—®é¢˜3ï¼šé…ç½®æ··ä¹±é£é™©
å¦‚æœç»„ä»¶è¢«é”™è¯¯åœ°æ”¾åœ¨äº†ä¸åŒçš„Providerä¸‹ï¼Œå¯èƒ½å¯¼è‡´æ„å¤–è¡Œä¸ºã€‚

**è§£å†³æ–¹æ¡ˆï¼šç»‘å®šéªŒè¯**
```tsx
// åˆ›å»ºå¸¦éªŒè¯çš„ç»„ä»¶ç‰ˆæœ¬
const createInstanceBoundComponent = (
  Component: React.ComponentType<any>,
  expectedInstance?: string
) => {
  return (props: any) => {
    const { instanceName } = useLlmConnector();
    
    // éªŒè¯ç»‘å®šå…³ç³»
    if (expectedInstance && instanceName !== expectedInstance) {
      console.warn(
        `ç»„ä»¶æœŸæœ›ç»‘å®šåˆ°å®ä¾‹ "${expectedInstance}"ï¼Œ` +
        `ä½†å®é™…ç»‘å®šåˆ°äº† "${instanceName}"`
      );
    }
    
    return <Component {...props} instanceName={instanceName} />;
  };
};

// ä½¿ç”¨æ–¹å¼
const SummaryConnectionForm = createInstanceBoundComponent(
  ConnectionForm, 
  'summary'
);

const ChatModelSelect = createInstanceBoundComponent(
  ModelSelect,
  'chat'
);
```

## ğŸ’¡ æ¨èçš„æœ€ä½³å®è·µ

### æ–¹æ¡ˆ1ï¼šä¿æŒç°çŠ¶ + è§†è§‰å¢å¼º â­â­â­â­â­
**é€‚ç”¨åœºæ™¯**ï¼šå¤§éƒ¨åˆ†æƒ…å†µï¼Œæœ€ç®€å•æœ‰æ•ˆ

```tsx
// åœ¨ç»„ä»¶ä¸­æ·»åŠ å®ä¾‹æ ‡è¯†ï¼Œä½†ä¸æ”¹å˜æ ¸å¿ƒé€»è¾‘
function App() {
  return (
    <div className="multi-instance-app">
      <LlmConnectorProvider name="summary" storageKey="summary-config">
        <section className="instance-section summary-theme">
          <h2>ğŸ“„ æ–‡æ¡£æ€»ç»“åŠ©æ‰‹</h2>
          <div className="instance-badge">å®ä¾‹: summary</div>
          <ConnectionFormZh />
          <ModelSelectZh />
          <TokenUsageZh />
        </section>
      </LlmConnectorProvider>
      
      <LlmConnectorProvider name="chat" storageKey="chat-config">
        <section className="instance-section chat-theme">
          <h2>ğŸ’¬ æ™ºèƒ½å¯¹è¯åŠ©æ‰‹</h2>
          <div className="instance-badge">å®ä¾‹: chat</div>
          <ConnectionFormZh />
          <ModelSelectZh />
          <TokenUsageZh />
        </section>
      </LlmConnectorProvider>
    </div>
  );
}
```

### æ–¹æ¡ˆ2ï¼šä¸“ç”¨ç»„ä»¶ â­â­â­
**é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦ä¸¥æ ¼æ§åˆ¶ç»‘å®šå…³ç³»

```tsx
// ä¸ºä¸åŒå®ä¾‹åˆ›å»ºä¸“ç”¨ç»„ä»¶
const SummaryConfigPanel = () => (
  <LlmConnectorProvider name="summary" storageKey="summary-config">
    <div className="config-panel summary-theme">
      <h3>ğŸ“„ æ€»ç»“åŠ©æ‰‹é…ç½®</h3>
      <ConnectionFormZh />
      <ModelSelectZh />
      <TokenUsageZh />
    </div>
  </LlmConnectorProvider>
);

const ChatConfigPanel = () => (
  <LlmConnectorProvider name="chat" storageKey="chat-config">
    <div className="config-panel chat-theme">
      <h3>ğŸ’¬ å¯¹è¯åŠ©æ‰‹é…ç½®</h3>
      <ConnectionFormZh />
      <ModelSelectZh />
      <TokenUsageZh />  
    </div>
  </LlmConnectorProvider>
);

// ä½¿ç”¨
function App() {
  return (
    <div>
      <SummaryConfigPanel />
      <ChatConfigPanel />
    </div>
  );
}
```

### æ–¹æ¡ˆ3ï¼šé…ç½®å¯¹è±¡ä¼ é€’ â­â­â­â­
**é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦ç¨‹åºåŒ–æ§åˆ¶

```tsx
// é€šè¿‡é…ç½®å¯¹è±¡ç»Ÿä¸€ç®¡ç†
const instanceConfigs = {
  summary: {
    name: 'summary',
    storageKey: 'summary-config',
    title: 'ğŸ“„ æ–‡æ¡£æ€»ç»“åŠ©æ‰‹',
    theme: 'summary-theme'
  },
  chat: {
    name: 'chat', 
    storageKey: 'chat-config',
    title: 'ğŸ’¬ æ™ºèƒ½å¯¹è¯åŠ©æ‰‹',
    theme: 'chat-theme'
  }
};

const InstancePanel = ({ config }: { config: typeof instanceConfigs.summary }) => (
  <LlmConnectorProvider name={config.name} storageKey={config.storageKey}>
    <section className={`instance-section ${config.theme}`}>
      <h2>{config.title}</h2>
      <div className="instance-badge">å®ä¾‹: {config.name}</div>
      <ConnectionFormZh />
      <ModelSelectZh />
      <TokenUsageZh />
    </section>
  </LlmConnectorProvider>
);

function App() {
  return (
    <div>
      {Object.values(instanceConfigs).map(config => (
        <InstancePanel key={config.name} config={config} />
      ))}
    </div>
  );
}
```

## ğŸ¯ ç»“è®º

**å¥½æ¶ˆæ¯**ï¼šå‰ç«¯ä¸‰ä¸ªåŸºç¡€ç»„ä»¶çš„å®ä¾‹ç»‘å®šæœºåˆ¶å·²ç»å®Œå…¨æ­£å¸¸å·¥ä½œï¼

**æ ¸å¿ƒåŸç†**ï¼š
- React Contextçš„è‡ªåŠ¨æŸ¥æ‰¾æœºåˆ¶ç¡®ä¿ç»„ä»¶ç»‘å®šåˆ°æœ€è¿‘çš„Provider
- `useConnectionManager()` Hooké€šè¿‡Contextè·å–å¯¹åº”å®ä¾‹çš„çŠ¶æ€
- æ¯ä¸ªProvideræœ‰ç‹¬ç«‹çš„çŠ¶æ€å’Œå­˜å‚¨ç©ºé—´

**æ¨èæ”¹è¿›**ï¼š
1. æ·»åŠ è§†è§‰æ ‡è¯†ï¼Œè®©ç»‘å®šå…³ç³»æ›´ç›´è§‚
2. å¢å¼ºè°ƒè¯•ä¿¡æ¯ï¼Œæ–¹ä¾¿é—®é¢˜æ’æŸ¥
3. ä½¿ç”¨é…ç½®å¯¹è±¡ç»Ÿä¸€ç®¡ç†å¤šå®ä¾‹

**æ— éœ€æ‹…å¿ƒ**ï¼šç»‘å®šæœºåˆ¶æœ¬èº«æ˜¯å¯é çš„ï¼Œä¸»è¦æ˜¯ç”¨æˆ·ä½“éªŒçš„ä¼˜åŒ–é—®é¢˜ï¼